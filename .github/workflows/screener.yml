name: Daily Stock Screening

on:
  schedule:
    - cron: '0 22 * * 1-5'   # æ¯æ—¥ 07:00 JSTï¼ˆæœˆã€œé‡‘ï¼‰
    - cron: '0 20 1 * *'      # æ¯æœˆ1æ—¥ 05:00 JSTï¼ˆãƒ†ã‚£ãƒƒã‚«ãƒ¼ãƒªã‚¹ãƒˆæ›´æ–°ï¼‰
  workflow_dispatch:
    inputs:
      update_tickers:
        description: 'Russell 2000ãƒ†ã‚£ãƒƒã‚«ãƒ¼ãƒªã‚¹ãƒˆã‚‚æ›´æ–°ã™ã‚‹'
        type: boolean
        default: false

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  # ============================================================
  # Job 1: Russell 2000ãƒ†ã‚£ãƒƒã‚«ãƒ¼ãƒªã‚¹ãƒˆæ›´æ–°ï¼ˆæœˆæ¬¡ï¼‰
  # ============================================================
  update_tickers:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    # æ¯æœˆ1æ—¥ OR æ‰‹å‹•ã§ update_tickers=true ã®å ´åˆã®ã¿å®Ÿè¡Œ
    if: |
      github.event_name == 'schedule' && contains(github.event.schedule, '0 20 1') ||
      github.event_name == 'workflow_dispatch' && github.event.inputs.update_tickers == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: pip install requests beautifulsoup4 lxml
      - name: Russell 2000ãƒ†ã‚£ãƒƒã‚«ãƒ¼ãƒªã‚¹ãƒˆæ›´æ–°
        run: python update_russell2000.py
      - name: æ›´æ–°çµæœã‚’ã‚³ãƒŸãƒƒãƒˆ
        run: |
          git config user.email "bot@github.com"
          git config user.name "Screener Bot"
          git add russell2000.txt
          git diff --staged --quiet || git commit -m "ğŸ“‹ Russell 2000ãƒ†ã‚£ãƒƒã‚«ãƒ¼ãƒªã‚¹ãƒˆæ›´æ–° $(date +'%Y-%m')"
          git push

  # ============================================================
  # Job 2: æ¯æ—¥ã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°
  # ============================================================
  screen:
    runs-on: ubuntu-latest
    timeout-minutes: 300
    # update_tickersãŒå®Ÿè¡Œã•ã‚ŒãŸå ´åˆã¯ãã®å¾Œã«å®Ÿè¡Œï¼ˆä¾å­˜é–¢ä¿‚ï¼‰
    # é€šå¸¸ã®å¹³æ—¥ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã§ã¯å˜ç‹¬å®Ÿè¡Œ
    needs: []
    if: |
      always() &&
      (github.event_name == 'schedule' && contains(github.event.schedule, '0 22') ||
       github.event_name == 'workflow_dispatch')
    steps:
      - uses: actions/checkout@v4
        with:
          # update_tickersãŒrussell2000.txtã‚’æ›´æ–°ã—ãŸå ´åˆã‚‚å–å¾—
          ref: main
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: pip install yfinance pandas numpy requests lxml html5lib beautifulsoup4
      - name: russell2000.txtã®ç¢ºèª
        run: |
          if [ -f russell2000.txt ]; then
            COUNT=$(wc -l < russell2000.txt)
            echo "russell2000.txt: ${COUNT}éŠ˜æŸ„"
          else
            echo "russell2000.txt: ãªã—ï¼ˆåˆå›ã¯update_tickersã‚’å…ˆã«å®Ÿè¡Œã—ã¦ãã ã•ã„ï¼‰"
          fi
      - name: ã‚¹ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°å®Ÿè¡Œ
        run: python screener_v4.py --mode full
      - name: çµæœã‚’ã‚³ãƒŸãƒƒãƒˆ
        run: |
          git config user.email "bot@github.com"
          git config user.name "Screener Bot"
          git add docs/
          git diff --staged --quiet || git commit -m "ğŸ“Š ã‚¹ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°æ›´æ–° $(date +'%Y-%m-%d')"
          git push

  # ============================================================
  # Job 3: GitHub Pages ãƒ‡ãƒ—ãƒ­ã‚¤
  # ============================================================
  deploy:
    needs: screen
    runs-on: ubuntu-latest
    if: always() && needs.screen.result == 'success'
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main
      - uses: actions/configure-pages@v4
      - uses: actions/upload-pages-artifact@v3
        with:
          path: docs/
      - id: deployment
        uses: actions/deploy-pages@v4
