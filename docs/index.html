<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Dashboard</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{background:#060a10;color:#ddeeff;font-family:monospace;min-height:100vh}
::-webkit-scrollbar{width:3px;height:3px}
::-webkit-scrollbar-thumb{background:#1a2840;border-radius:2px}
.row:hover{background:rgba(0,180,255,0.06)!important;cursor:pointer}
input[type=range]{accent-color:#00e5ff;cursor:pointer;width:100%}
button{cursor:pointer}
</style>
</head>
<body>
<div id="root"></div>
<script>
const e = React.createElement;
const {useState, useMemo, useEffect, useCallback} = React;

const rsCol = v => v>=90?"#00ff88":v>=80?"#7dff9e":v>=70?"#f0d060":v>=55?"#ff9933":"#ff4444";
const numCol = v => v>5?"#00e676":v>0?"#69f0ae":v<-5?"#ff5252":v<0?"#ff8a80":"#607d8b";
const fmt = (v,d=1) => v==null?"â€”":`${v>0?"+":""}${Number(v).toFixed(d)}%`;
const fmtRS = v => v==null?"â€”":Number(v).toFixed(1);
const TD = {padding:"7px 9px",borderBottom:"1px solid rgba(14,28,48,.6)",whiteSpace:"nowrap"};

const SCORE_DEF = [
  {min:8, label:"â—Ž æœ€æœ‰åŠ›", col:"#00ff88"},
  {min:6, label:"â—‹ æœ‰åŠ›",   col:"#7dff9e"},
  {min:4, label:"â–³ å€™è£œ",   col:"#f0d060"},
  {min:0, label:"âœ•",        col:"#4a6a88"},
];

function ScoreBadge({score}) {
  const d = SCORE_DEF.find(x => score >= x.min) || SCORE_DEF[3];
  return e("span", {style:{
    fontSize:10, padding:"2px 7px", borderRadius:4, fontWeight:700,
    background:`${d.col}18`, color:d.col, border:`1px solid ${d.col}40`
  }}, d.label);
}

function RSCell({val, isSort}) {
  if (val == null) return e("td", {style:{...TD, textAlign:"right", color:"#2a4a6a"}}, "â€”");
  const col = rsCol(val);
  return e("td", {style:{...TD, textAlign:"right"}},
    e("span", {style:{
      color:col, fontWeight:val>=80?700:400,
      background:isSort?`${col}14`:"transparent",
      borderRadius:3, padding:isSort?"1px 5px":0
    }}, fmtRS(val))
  );
}

function StatCard({label, val, col}) {
  return e("div", {style:{background:"#0a1320",border:"1px solid #0e1c30",borderRadius:10,padding:"9px 12px"}},
    e("div", {style:{fontSize:9,color:"#2a4a6a",textTransform:"uppercase",marginBottom:3}}, label),
    e("div", {style:{fontSize:22,fontWeight:500,color:col,fontFamily:"sans-serif"}}, val)
  );
}

function App() {
  const [rawData, setRawData] = useState(null);
  const [loading, setLoading] = useState(true);
  const [error, setError]     = useState(null);
  const [sortK, setSortK]     = useState("rs_p2");
  const [sortD, setSortD]     = useState("desc");
  const [search, setSearch]   = useState("");
  const [minRS, setMinRS]     = useState(0);
  const [minVCS, setMinVCS]   = useState(0);
  const [minStage, setMinStage] = useState(0);
  const [selected, setSelected] = useState(null);
  const [showP1, setShowP1]   = useState(false);
  const [showP2, setShowP2]   = useState(true);
  const [showP3, setShowP3]   = useState(true);
  const [showP4, setShowP4]   = useState(true);
  const [showAvg, setShowAvg] = useState(true);

  useEffect(() => {
    fetch("./data.json?t=" + Date.now())
      .then(r => { if (!r.ok) throw new Error("HTTP " + r.status); return r.json(); })
      .then(d => { setRawData(d); setLoading(false); })
      .catch(err => { setError(err.message); setLoading(false); });
  }, []);

  const rows = useMemo(() => {
    if (!rawData) return [];
    return (rawData.stocks || []).filter(s => {
      if (search) { const q = search.toUpperCase(); if (!s.ticker?.includes(q)) return false; }
      if ((s.rs_p2 ?? 0) < minRS)     return false;
      if ((s.vcs ?? 0) < minVCS)      return false;
      if ((s.stage2 ?? 0) < minStage) return false;
      return true;
    }).sort((a, b) => {
      const av = a[sortK] ?? -999, bv = b[sortK] ?? -999;
      return sortD === "desc" ? bv - av : av - bv;
    });
  }, [rawData, search, sortK, sortD, minRS, minVCS, minStage]);

  const handleSort = useCallback(k => {
    if (k === sortK) setSortD(d => d === "desc" ? "asc" : "desc");
    else { setSortK(k); setSortD("desc"); }
  }, [sortK]);

  const rsCols = [
    {k:"rs_p1", label:"RS5",   show:showP1, set:setShowP1},
    {k:"rs_p2", label:"RS21â˜…", show:showP2, set:setShowP2},
    {k:"rs_p3", label:"RS63",  show:showP3, set:setShowP3},
    {k:"rs_p4", label:"RS126", show:showP4, set:setShowP4},
    {k:"rs_avg",label:"Avg",   show:showAvg,set:setShowAvg},
  ].filter(c => c.show);

  if (loading) return e("div", {style:{display:"flex",alignItems:"center",justifyContent:"center",minHeight:"100vh"}},
    e("div", {style:{color:"#00e5ff",fontSize:16}}, "ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ä¸­...")
  );

  if (error) return e("div", {style:{display:"flex",alignItems:"center",justifyContent:"center",minHeight:"100vh",flexDirection:"column",gap:12}},
    e("div", {style:{fontSize:40}}, "âš ï¸"),
    e("div", {style:{color:"#ff5252",fontSize:14}}, "å–å¾—å¤±æ•—: " + error),
    e("button", {onClick:()=>window.location.reload(), style:{marginTop:8,background:"#0a1320",border:"1px solid #0e1c30",borderRadius:8,padding:"8px 20px",color:"#4a6a88",fontSize:12}}, "å†è©¦è¡Œ")
  );

  const market = rawData.market;
  const topN   = rows.filter(r => (r.score??0) >= 8).length;
  const midN   = rows.filter(r => (r.score??0) >= 6 && (r.score??0) < 8).length;
  const vcsN   = rows.filter(r => (r.vcs??0) >= 80).length;

  const thStyle = (k, align) => ({
    padding:"8px 9px", textAlign:align||"right",
    color:sortK===k?"#00e5ff":"#1e3a5a",
    fontSize:9, fontWeight:700, textTransform:"uppercase",
    letterSpacing:".08em", userSelect:"none", cursor:"pointer",
    background:sortK===k?"rgba(0,229,255,.06)":"transparent",
    borderBottom:sortK===k?"2px solid #00e5ff":"none",
  });

  return e("div", {style:{background:"#060a10",minHeight:"100vh",fontFamily:"monospace",color:"#ddeeff"}},

    e("div", {style:{position:"sticky",top:0,zIndex:100,background:"rgba(6,10,16,.97)",borderBottom:"1px solid #0e1c30",padding:"9px 14px",display:"flex",alignItems:"center",gap:10,flexWrap:"wrap"}},
      e("div", {style:{fontFamily:"sans-serif",fontSize:18,fontWeight:800}},
        "Stock", e("span", {style:{color:"#00e5ff"}}, "Screen")),
      e("div", {style:{fontSize:9,color:"#2a4a6a",lineHeight:1.6}},
        e("div", {style:{color:"#00e5ff"}}, rawData.updated_jst),
        e("div", null, `${rawData.universe_size}éŠ˜æŸ„ â†’ ${rawData.total_found}å€™è£œ`)),
      e("input", {value:search, onChange:ev=>setSearch(ev.target.value), placeholder:"Tickeræ¤œç´¢",
        style:{background:"#0a1320",border:"1px solid #0e1c30",borderRadius:8,padding:"5px 11px",color:"#ddeeff",fontFamily:"monospace",fontSize:12,width:140,outline:"none"}}),
      e("div", {style:{display:"flex",gap:3,alignItems:"center"}},
        e("span", {style:{fontSize:9,color:"#2a4a6a"}}, "RS:"),
        ...[[" 5d",showP1,setShowP1],["21dâ˜…",showP2,setShowP2],["63d",showP3,setShowP3],["126d",showP4,setShowP4],["Avg",showAvg,setShowAvg]].map(
          ([l,v,s]) => e("button", {key:l, onClick:()=>s(x=>!x), style:{
            background:v?"rgba(0,229,255,.15)":"#0a1320",
            border:`1px solid ${v?"rgba(0,229,255,.4)":"#0e1c30"}`,
            borderRadius:6, padding:"3px 8px", color:v?"#00e5ff":"#2a4a6a", fontFamily:"monospace", fontSize:9
          }}, l))),
      e("button", {onClick:()=>window.location.reload(), style:{background:"#0a1320",border:"1px solid #0e1c30",borderRadius:8,padding:"5px 11px",color:"#4a6a88",fontSize:11}}, "ðŸ”„ æ›´æ–°")),

    e("div", {style:{display:"flex",maxWidth:1800,margin:"0 auto"}},

      e("div", {style:{width:175,flexShrink:0,padding:"14px 11px",borderRight:"1px solid #0e1c30",display:"flex",flexDirection:"column",gap:14}},
        e("div", {style:{fontSize:9,color:"#1e3450",letterSpacing:".12em",textTransform:"uppercase"}}, "ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼"),
        ...[
          {label:"RS P2 æœ€ä½Ž",  val:minRS,    set:setMinRS,    min:0, max:99, step:5, d:v=>`${v}+`},
          {label:"VCS æœ€ä½Ž",    val:minVCS,   set:setMinVCS,   min:0, max:90, step:5, d:v=>`${v}+`},
          {label:"Stage2 æœ€ä½Ž", val:minStage, set:setMinStage, min:0, max:9,  step:1, d:v=>`${v}/9+`},
        ].map(f => e("div", {key:f.label},
          e("div", {style:{display:"flex",justifyContent:"space-between",marginBottom:4}},
            e("span", {style:{fontSize:10,color:"#4a6a88"}}, f.label),
            e("span", {style:{fontSize:10,color:"#00e5ff",fontWeight:700}}, f.d(f.val))),
          e("input", {type:"range",min:f.min,max:f.max,step:f.step,value:f.val,onChange:ev=>f.set(+ev.target.value)}))),
        e("button", {onClick:()=>{setMinRS(0);setMinVCS(0);setMinStage(0);setSearch("");},
          style:{background:"none",border:"1px solid #0e1c30",borderRadius:6,color:"#4a6a88",padding:"5px 0",fontSize:11}}, "ãƒªã‚»ãƒƒãƒˆ"),
        market && e("div", {style:{borderTop:"1px solid #0e1c30",paddingTop:12}},
          e("div", {style:{fontSize:9,color:"#1e3450",textTransform:"uppercase",marginBottom:8}}, "ãƒžã‚¯ãƒ­"),
          e("div", {style:{fontSize:13,fontWeight:700,color:"#ddeeff",marginBottom:6}}, `${market.icon} ${market.mode}`),
          e("div", {style:{fontSize:11,color:"#f0d060",marginBottom:8}}, `VIX: ${market.vix}`),
          ...Object.entries(market.etfs||{}).map(([etf,d]) =>
            e("div", {key:etf, style:{fontSize:10,color:d.above&&d.rising?"#00e676":"#ff5252",marginBottom:3}},
              `${d.above&&d.rising?"ðŸŸ¢":"ðŸ”´"} ${etf} $${d.close}`))),
        e("div", {style:{borderTop:"1px solid #0e1c30",paddingTop:10,fontSize:9,color:"#2a4a6a",lineHeight:2}},
          e("div", {style:{color:"#4a6a88",marginBottom:4}}, "ã‚¹ã‚³ã‚¢ï¼ˆæœ€å¤§10ï¼‰"),
          "RSâ‰¥90 +3 / â‰¥70 +2 / â‰¥50 +1", e("br"),
          "VCSâ‰¥80 +3 / â‰¥60 +1", e("br"),
          "Stage2=9 +2 / â‰¥7 +1", e("br"),
          "52W-10%ä»¥å†… +1")),

      e("div", {style:{flex:1,padding:"12px 13px",minWidth:0}},
        e("div", {style:{display:"grid",gridTemplateColumns:"repeat(4,1fr)",gap:8,marginBottom:10}},
          e(StatCard, {label:"è¡¨ç¤ºéŠ˜æŸ„", val:rows.length, col:"#00e5ff"}),
          e(StatCard, {label:"â—Ž æœ€æœ‰åŠ›", val:topN,        col:"#00ff88"}),
          e(StatCard, {label:"â—‹ æœ‰åŠ›",   val:midN,        col:"#7dff9e"}),
          e(StatCard, {label:"VCSâ‰¥80",  val:vcsN,         col:"#00ff88"})),

        selected && e("div", {style:{background:"rgba(0,255,140,.04)",border:"1px solid rgba(0,255,140,.18)",borderRadius:12,padding:"12px 16px",marginBottom:10}},
          e("div", {style:{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:10}},
            e("div", {style:{display:"flex",alignItems:"center",gap:10}},
              e("span", {style:{fontFamily:"sans-serif",fontSize:22,fontWeight:800,color:"#00ff88"}}, selected.ticker),
              e(ScoreBadge, {score:selected.score??0})),
            e("button", {onClick:()=>setSelected(null), style:{background:"none",border:"none",color:"#4a6a88",fontSize:16}}, "âœ•")),
          e("div", {style:{display:"grid",gridTemplateColumns:"repeat(4,1fr)",gap:6}},
            ...[
              {l:"RS P1(5æ—¥)",   v:fmtRS(selected.rs_p1),  col:rsCol(selected.rs_p1??0)},
              {l:"RS P2(21æ—¥)â˜…", v:fmtRS(selected.rs_p2),  col:rsCol(selected.rs_p2??0)},
              {l:"RS P3(63æ—¥)",  v:fmtRS(selected.rs_p3),  col:rsCol(selected.rs_p3??0)},
              {l:"RS P4(126æ—¥)", v:fmtRS(selected.rs_p4),  col:rsCol(selected.rs_p4??0)},
              {l:"RS Avg",       v:fmtRS(selected.rs_avg), col:rsCol(selected.rs_avg??0)},
              {l:"1Mãƒªã‚¿ãƒ¼ãƒ³",   v:fmt(selected.m1),        col:numCol(selected.m1??0)},
              {l:"3Mãƒªã‚¿ãƒ¼ãƒ³",   v:fmt(selected.m3),        col:numCol(selected.m3??0)},
              {l:"6Mãƒªã‚¿ãƒ¼ãƒ³",   v:fmt(selected.m6),        col:numCol(selected.m6??0)},
              {l:"Stage2",  v:`${selected.stage2}/9`,       col:(selected.stage2??0)>=8?"#00e5ff":"#f0d060"},
              {l:"VCS",     v:String(selected.vcs??"â€”"),    col:(selected.vcs??0)>=80?"#00ff88":(selected.vcs??0)>=60?"#00e676":"#f0d060"},
              {l:"52Wé«˜å€¤æ¯”", v:fmt(selected.pct_high),     col:numCol(selected.pct_high??0)},
              {l:"ADR%",    v:selected.adr?`${selected.adr}%`:"â€”", col:"#ddeeff"},
              {l:"æ ªä¾¡",    v:`$${selected.close}`,          col:"#ddeeff"},
              {l:"æåˆ‡ã‚Š",  v:`$${selected.stop}`,           col:"#ff5252"},
              {l:"TP1(+10%)", v:`$${selected.tp1}`,         col:"#00ff88"},
              {l:"TP2(+20%)", v:`$${selected.tp2}`,         col:"#00e5ff"},
            ].map(m => e("div", {key:m.l, style:{background:"#0a1320",border:"1px solid #0e1c30",borderRadius:8,padding:"7px 10px",textAlign:"center"}},
              e("div", {style:{fontSize:9,color:"#2a4a6a",marginBottom:3}}, m.l),
              e("div", {style:{fontSize:13,fontWeight:500,color:m.col}}, m.v))))),

        e("div", {style:{background:"#0a1320",border:"1px solid #0e1c30",borderRadius:12,overflow:"hidden"}},
          e("div", {style:{overflowX:"auto"}},
            e("table", {style:{width:"100%",borderCollapse:"collapse",fontSize:11}},
              e("thead", null,
                e("tr", {style:{background:"#060a10",borderBottom:"1px solid #0e1c30"}},
                  e("th", {onClick:()=>handleSort("rs_p2"), style:{...thStyle("rs_p2","center")}},
                    "RSâ˜…", sortK==="rs_p2"&&(sortD==="desc"?" â†“":" â†‘")),
                  e("th", {style:{padding:"8px 9px",textAlign:"left",color:"#1e3a5a",fontSize:9,fontWeight:700,textTransform:"uppercase",letterSpacing:".08em"}}, "Ticker"),
                  ...rsCols.map(c => e("th", {key:c.k, onClick:()=>handleSort(c.k), style:thStyle(c.k)},
                    c.label, sortK===c.k&&(sortD==="desc"?" â†“":" â†‘"))),
                  ...[
                    {k:"m1",label:"1M%"},{k:"m3",label:"3M%"},{k:"m6",label:"6M%"},
                    {k:"stage2",label:"Stage2"},{k:"vcs",label:"VCS"},
                    {k:"pct_high",label:"52W"},{k:"adr",label:"ADR%"},
                    {k:"close",label:"Price"},{k:"score",label:"Score"},
                  ].map(c => e("th", {key:c.k, onClick:()=>handleSort(c.k), style:thStyle(c.k)},
                    c.label, sortK===c.k&&(sortD==="desc"?" â†“":" â†‘"))),
                  e("th", {style:{padding:"8px 9px",fontSize:9,color:"#1e3a5a",textTransform:"uppercase"}}, "è©•ä¾¡"))),
              e("tbody", null,
                rows.length === 0
                  ? e("tr", null, e("td", {colSpan:20, style:{padding:"40px",textAlign:"center",color:"#2a4a6a"}}, "æ¡ä»¶ã«åˆã†éŠ˜æŸ„ãŒã‚ã‚Šã¾ã›ã‚“"))
                  : rows.map(d => e("tr", {key:d.ticker, className:"row", onClick:()=>setSelected(d),
                      style:{background:selected?.ticker===d.ticker?"rgba(0,255,140,0.05)":"transparent"}},
                    e("td", {style:{...TD,textAlign:"center"}},
                      e("span", {style:{display:"inline-block",background:`${rsCol(d.rs_p2??0)}15`,
                        color:rsCol(d.rs_p2??0),border:`1px solid ${rsCol(d.rs_p2??0)}35`,
                        borderRadius:5,padding:"1px 7px",fontSize:12,fontWeight:700}}, fmtRS(d.rs_p2))),
                    e("td", {style:{...TD,textAlign:"left"}},
                      e("span", {style:{fontFamily:"sans-serif",fontWeight:800,color:"#00e5ff",fontSize:13}}, d.ticker)),
                    ...rsCols.map(c => e(RSCell, {key:c.k, val:d[c.k], isSort:sortK===c.k})),
                    e("td", {style:{...TD,textAlign:"right",color:numCol(d.m1??0)}},  fmt(d.m1)),
                    e("td", {style:{...TD,textAlign:"right",color:numCol(d.m3??0)}},  fmt(d.m3)),
                    e("td", {style:{...TD,textAlign:"right",color:numCol(d.m6??0)}},  fmt(d.m6)),
                    e("td", {style:{...TD,textAlign:"right",color:(d.stage2??0)>=8?"#00e5ff":(d.stage2??0)>=7?"#f0d060":"#ff8a80"}}, `${d.stage2}/9`),
                    e("td", {style:{...TD,textAlign:"right"}},
                      e("span", {style:{fontWeight:700,color:(d.vcs??0)>=80?"#00ff88":(d.vcs??0)>=60?"#00e676":(d.vcs??0)>=40?"#2962ff":"#607d8b"}},
                        d.vcs??"â€”")),
                    e("td", {style:{...TD,textAlign:"right",color:numCol(d.pct_high??0)}}, fmt(d.pct_high)),
                    e("td", {style:{...TD,textAlign:"right",color:"#607d8b"}}, d.adr?`${d.adr}%`:"â€”"),
                    e("td", {style:{...TD,textAlign:"right",color:"#ddeeff",fontWeight:500}}, `$${d.close}`),
                    e("td", {style:{...TD,textAlign:"right",fontFamily:"sans-serif",fontWeight:700,color:"#ddeeff"}}, d.score??0),
                    e("td", {style:{...TD,textAlign:"center"}}, e(ScoreBadge, {score:d.score??0}))))))),
        e("div", {style:{marginTop:8,fontSize:9,color:"#1e3450",display:"flex",justifyContent:"space-between"}},
          e("span", null, "RS=percentrank(TICKER/SPY,period) | â˜…P2(21æ—¥)ã‚½ãƒ¼ãƒˆ | è¡Œã‚¯ãƒªãƒƒã‚¯â†’è©³ç´°"),
          e("span", null, `${rows.length}ä»¶ / ${rawData.total_found}å€™è£œ / ${rawData.universe_size}ã‚¹ã‚­ãƒ£ãƒ³`)))));
}

ReactDOM.createRoot(document.getElementById("root")).render(e(App));
</script>
</body>
</html>
